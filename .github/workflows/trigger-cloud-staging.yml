# Trigger cloud staging deployment when app changes are pushed to main
# This allows the cloud repo to deploy staging when app code changes,
# even though app and cloud are in separate repositories
#
# NOTE: This workflow requires a Personal Access Token (PAT) with 'repo' scope
# stored as CROSS_REPO_TOKEN secret. GITHUB_TOKEN cannot trigger repository_dispatch
# events in other repositories, even within the same organization.
name: "Trigger Cloud Staging Deployment"

on:
  push:
    branches: [main]
    paths:
      - "src/**"
      - "package.json"
      - "vite.config.ts"
      - "tsconfig.json"
      - ".github/workflows/trigger-cloud-staging.yml"

# Only trigger one deployment at a time
concurrency:
  group: trigger-cloud-staging
  cancel-in-progress: false

jobs:
  trigger-cloud-deploy:
    name: Trigger Cloud Staging Deployment
    runs-on: ubuntu-latest
    # Only trigger if this is a push to main (not a PR)
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      contents: write
    steps:
      - name: Trigger Cloud Staging Deployment
        uses: actions/github-script@v7
        with:
          # Use PAT for cross-repository access (GITHUB_TOKEN cannot trigger repository_dispatch in other repos)
          github-token: ${{ secrets.CROSS_REPO_TOKEN || secrets.GITHUB_TOKEN }}
          script: |
            const { data: response } = await github.rest.repos.createDispatchEvent({
              owner: 'brewos-io',
              repo: 'cloud',
              event_type: 'deploy-staging',
              client_payload: {
                triggered_by: 'app',
                app_commit: context.sha,
                app_ref: context.ref,
                app_repo: context.repo.repo,
                message: `Staging deployment triggered by app changes in commit ${context.sha.substring(0, 7)}`
              }
            });

            console.log('âœ“ Triggered cloud staging deployment');
            console.log(`App commit: ${context.sha}`);
            console.log(`App ref: ${context.ref}`);
